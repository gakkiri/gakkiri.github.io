<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>一些实用的pytorch脚本 | gakkiri&#39;s blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="一些在使用pytorch时可能会用到的比较有用的脚本归一化1234def normalize_channels(img):      _min, _max = img.min(axis=(0,1)), img.std(axis=(0,1))      img = (img - _min) &#x2F; (_max - _min)      return img  绘制第一个filterdef plot_fi">
<meta property="og:type" content="article">
<meta property="og:title" content="一些实用的pytorch脚本">
<meta property="og:url" content="http:&#x2F;&#x2F;gakkiri.gitbuh.io&#x2F;2019&#x2F;10&#x2F;17&#x2F;%E4%B8%80%E4%BA%9B%E5%AE%9E%E7%94%A8%E7%9A%84pytorch%E8%84%9A%E6%9C%AC&#x2F;index.html">
<meta property="og:site_name" content="gakkiri&#39;s blog">
<meta property="og:description" content="一些在使用pytorch时可能会用到的比较有用的脚本归一化1234def normalize_channels(img):      _min, _max = img.min(axis=(0,1)), img.std(axis=(0,1))      img = (img - _min) &#x2F; (_max - _min)      return img  绘制第一个filterdef plot_fi">
<meta property="og:locale" content="zn">
<meta property="og:updated_time" content="2019-10-17T16:07:19.168Z">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="gakkiri&#39;s blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">gakkiri&#39;s blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://gakkiri.gitbuh.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-一些实用的pytorch脚本" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/10/17/%E4%B8%80%E4%BA%9B%E5%AE%9E%E7%94%A8%E7%9A%84pytorch%E8%84%9A%E6%9C%AC/" class="article-date">
  <time datetime="2019-10-17T15:59:15.000Z" itemprop="datePublished">2019-10-17</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      一些实用的pytorch脚本
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="一些在使用pytorch时可能会用到的比较有用的脚本"><a href="#一些在使用pytorch时可能会用到的比较有用的脚本" class="headerlink" title="一些在使用pytorch时可能会用到的比较有用的脚本"></a>一些在使用pytorch时可能会用到的比较有用的脚本</h2><h3 id="归一化"><a href="#归一化" class="headerlink" title="归一化"></a>归一化</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">def normalize_channels(img):  </span><br><span class="line">    _min, _max = img.min(axis=(0,1)), img.std(axis=(0,1))  </span><br><span class="line">    img = (img - _min) / (_max - _min)  </span><br><span class="line">    return img</span><br></pre></td></tr></table></figure>

<h3 id="绘制第一个filter"><a href="#绘制第一个filter" class="headerlink" title="绘制第一个filter"></a>绘制第一个filter</h3><pre><code>def plot_first_kernels(weight):  
    with torch.no_grad():  
        filters = weight.detach().cpu().float().numpy().transpose([0,2,3,1])  # channels last  
        filters = normalize_channels(filters)  
        filters /= filters.max()  
    n = filters.shape[0]  
    cols = math.ceil(math.sqrt(n))  
    rows = math.ceil(n / cols)  

    fig, axs = plt.subplots(rows, cols)  
    for c in range(cols):  
        for r in range(rows):  
            idx = r + c * rows  
            if idx &lt; n:  
                axs[r,c].imshow(filters[idx])  
            axs[r,c].set_axis_off()  </code></pre><h3 id="绘制给定参数各层的l2范数分布"><a href="#绘制给定参数各层的l2范数分布" class="headerlink" title="绘制给定参数各层的l2范数分布"></a>绘制给定参数各层的l2范数分布</h3><pre><code>def plot_norms(named_parameters, figsize=None):  
    from matplotlib import cm  
    p = [0, 25, 50, 75, 100]  
    with torch.no_grad():  
        norms, names = [], []  
        for name, param in named_parameters:  
                param_flat = param.view(param.shape[0], -1)  
                norms.append(np.percentile(torch.norm(param_flat, p=2, dim=1).cpu().numpy(), p))  
                names.append(name)  

    n = len(norms)  
    inv_p = np.arange(len(p)-1,-1,-1)  
    norms = np.array(norms)  
    if figsize is None:  
        figsize = (np.min([16, n]), 6)  
    plt.figure(figsize=figsize)  
    plt.yscale(&apos;log&apos;)  
    for i,c in zip(inv_p, cm.get_cmap(&apos;inferno&apos;)(0.1+inv_p/len(p))):  
        plt.bar(np.arange(n), norms[:,i], lw=1, color=c)  
    plt.xticks(range(n), names, rotation=&quot;vertical&quot;)  
    plt.xlabel(&quot;layers&quot;)  
    plt.ylabel(&quot;norm distribution&quot;)  
    plt.title(&quot;Kernel L2 Norms&quot;)  
    plt.grid(True)  
    plt.legend(labels=[f&apos;{i}%&apos; for i in p[::-1]])  </code></pre><h3 id="绘制不同层的梯度"><a href="#绘制不同层的梯度" class="headerlink" title="绘制不同层的梯度"></a>绘制不同层的梯度</h3><pre><code>def plot_grad_flow(named_parameters, figsize=None):  
    from matplotlib.lines import Line2D  
    avg_grads = []  
    max_grads= []  
    layers = []  
    for n, p in named_parameters:  
        if (p.grad is not None) and (&quot;bias&quot; not in n):  
            layers.append(n)  
            avg_grads.append(p.grad.abs().mean())  
            max_grads.append(p.grad.abs().max())  
    if figsize is None:  
        figsize = (np.min([16, len(avg_grads)]), 6)  
    plt.figure(figsize=figsize)  
    plt.bar(np.arange(len(max_grads)), max_grads, alpha=0.1, lw=1, color=&quot;c&quot;)  
    plt.bar(np.arange(len(max_grads)), avg_grads, alpha=0.1, lw=1, color=&quot;b&quot;)  
    plt.hlines(0, 0, len(layers)+1, lw=2, color=&quot;k&quot; )  
    plt.xticks(range(0, len(layers), 1), layers, rotation=&quot;vertical&quot;)  
    plt.xlim(left=-1, right=len(layers))  
    plt.xlabel(&quot;Layers&quot;)  
    plt.ylabel(&quot;Gradient Magnitude&quot;)  
    plt.yscale(&apos;log&apos;)  
    plt.title(&quot;Gradient flow&quot;)  
    plt.grid(True)  
    plt.legend([Line2D([0], [0], color=&quot;c&quot;, lw=4),  
                Line2D([0], [0], color=&quot;b&quot;, lw=4),  
                Line2D([0], [0], color=&quot;k&quot;, lw=4)], [&apos;max-gradient&apos;, &apos;mean-gradient&apos;, &apos;zero-gradient&apos;])  </code></pre><h3 id="Metrics"><a href="#Metrics" class="headerlink" title="Metrics"></a>Metrics</h3><pre><code>class Metrics(RunningAverage):  
    def __init__(self, evaluator, eval_loader, output_transform, interactive=False):  
        super().__init__(alpha=0.9, output_transform=output_transform)  
        self.evaluator = evaluator  
        self.eval_loader = eval_loader  
        self.interactive = interactive  
        self.validation_history = {}  
        self.loss_history = []  

    def attach(self, engine, name):  
        super().attach(engine, name)  
        engine.add_event_handler(Events.EPOCH_COMPLETED, self.run_evaluation)  

    def compute(self):  
        loss = super().compute()  
        self.loss_history.append(loss)  
        return loss  

    def run_evaluation(self, engine=None):  
        self.evaluator.run(self.eval_loader)  
        if self.interactive:  
            print(self.evaluator.state.metrics)  
        # save validation_history  
        for k,v in self.evaluator.state.metrics.items():  
            if k not in self.validation_history.keys():  
                self.validation_history[k] = [v]  
            else:  
                self.validation_history[k].append(v)  

    def plot(self, epoch_size=None, figsize=(16, 4)):  
        plt.figure(figsize=figsize)  
        ax = plt.subplot()  
        ax.set_yscale(&apos;log&apos;)  
        ax.set_xlabel(&apos;Batches processed&apos;)  
        ax.set_ylabel(&quot;loss&quot;)  
        ax.plot(self.loss_history, label=&apos;Train Loss&apos;)  
        ax2 = ax.twinx()  
        ax2.set_ylabel(&quot;score&quot;)  
        for k,v in self.validation_history.items():  
            if epoch_size is None:  
                epoch_size = len(self.loss_history) // len(v)  
            iters = np.arange(1, len(v)+1) * epoch_size  
            if k == &apos;Loss&apos;:  
                  ax.plot(iters, v, label=&apos;Valid Loss&apos;)  
            else: ax2.plot(iters, v, label=k, ls=&apos;--&apos;)  
        ax.legend(frameon=False, loc=&apos;upper left&apos;)  
        ax2.legend(frameon=False, loc=&apos;lower left&apos;)  </code></pre>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://gakkiri.gitbuh.io/2019/10/17/%E4%B8%80%E4%BA%9B%E5%AE%9E%E7%94%A8%E7%9A%84pytorch%E8%84%9A%E6%9C%AC/" data-id="ck1ux0wqn0000rwwncc3w0uc0" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/10/">October 2019</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/10/17/%E4%B8%80%E4%BA%9B%E5%AE%9E%E7%94%A8%E7%9A%84pytorch%E8%84%9A%E6%9C%AC/">一些实用的pytorch脚本</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 gk<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>